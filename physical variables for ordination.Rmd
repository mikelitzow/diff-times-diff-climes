---
title: "physical variables for ordination"
author: "MIke Litzow"
date: "7/21/2018"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ncdf4)
library(chron)
library(fields)
library(maps)
library(mapdata)
library(dplyr)
library(reshape2)
library(zoo)
```

## Organize variables for analysis

Large-scale climate patterns			
    Atmospheric drivers	
        NDJ AL SLP & NPI	
    Basin-scale ocean patterns		
        FMA PDO	& NPGO	
Local environmental variables			
	  Coastal precipitation / freshwater discharge	
	      NDJ SLP gradient, FMA	FW discharge	
	  Water column stability		
	      FMA GAK1 salinity	& Wind stress	
	  Downwelling intensity
	      FMA &  MJJ UW index
	  Temperature		
	      FMA & MJJ SST
	  Advection/alongshore transport	
	      NDJ Papa index, FMA and MJJ SSH

Create a data frame for the output.
```{r}
clim.vars <- data.frame(year=1950:2012, NDJ.AL=NA, NDJ.NPI=NA, FMA.PDO=NA, FMA.NPGO=NA, NDJ.grad=NA, FMA.FW=NA, MJJ.FW=NA, FMA.sal=NA, FMA.WS=NA, FMA.x.WS=NA, MJJ.x.WS=NA, FMA.y.WS=NA, MJJ.y.WS=NA, MJJ.UW=NA, FMA.SST=NA, MJJ.SST=NA, Papa=NA, FMA.SSH=NA, MJJ.SSH=NA)
```

First, NDJ AL SLP.
```{r, echo=T}

#load SLP
nc <- nc_open("/Users/MikeLitzow 1/Documents/R/climate data/prmsl.mon.mean.7.28.15.nc") 

# get dates (hours since 1/1/1800)
raw <- ncvar_get(nc, "time")
h <- raw/24
d <- dates(h, origin = c(1,1,1800))

# Pick start and end dates (Jan 1949-Dec 2012):
d <- d[937:1704] 

# Extract AL area, 48-56 deg. N, 192-206 deg. E 
ncvar_get(nc, "lon") 
ncvar_get(nc, "lat")

x <- ncvar_get(nc, "lon", start=97, count=8)
y <- ncvar_get(nc, "lat", start=18, count=5)

SLP <- ncvar_get(nc, "prmsl", start=c(97,18,937), count=c(8,5,length(d)), verbose = F)

# manipulate as needed
SLP <- aperm(SLP, 3:1)  # First, reverse order of dimensions ("transpose" array)
SLP <- SLP[,5:1,]  # Reverse order of latitudes to be increasing for convenience (in later plotting)
y <- rev(y) 

SLP <- matrix(SLP, nrow=dim(SLP)[1], ncol=prod(dim(SLP)[2:3]))  # Change to matrix

# Keep track of corresponding latitudes and longitudes of each column:
lat <- rep(y, length(x))   # Vector of latitudes
lon <- rep(x, each = length(y))   # Vector of longitudes
dimnames(SLP) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

# check
 SLP.mean <- colMeans(SLP)
 z <- t(matrix(SLP.mean,length(y)))  
 image(x,y,z, col=tim.colors(64), xlim=c(130,250), ylim=c(20,66))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)

# smooth with 5 month rolling mean for each cell
SLP <- apply(SLP, 2, function(x) rollmean(x, 5, mean, fill=NA))
 
# now get monthly means weighted by area, using an arithmetic mean
weight <- sqrt(cos(lat*pi/180))

AL.mu <- apply(SLP, 1, function(x) weighted.mean(x,weight, na.rm=T))

# now limit to NDJ
m <- months(d)
AL.mu <- AL.mu[m %in% c("Nov", "Dec", "Jan")]
yr <- years(d)

# advance yr to match Jan
yr <- as.numeric(as.character(yr))
yr[m %in% c("Nov", "Dec")] <- 1 + yr[m %in% c("Nov", "Dec")]
yr <- yr[m %in% c("Nov", "Dec", "Jan")]

AL.mu <- tapply(AL.mu, yr, mean)

clim.vars$NDJ.AL=AL.mu[names(AL.mu) %in% 1950:2012]
```

Now NDJ NPI.
```{r, echo=T}
#load SLP
nc <- nc_open("/Users/MikeLitzow 1/Documents/R/climate data/prmsl.mon.mean.7.28.15.nc") 

# get dates (hours since 1/1/1800)
raw <- ncvar_get(nc, "time")
h <- raw/24
d <- dates(h, origin = c(1,1,1800))

# Pick start and end dates (Jan 1949-Dec 2012):
d <- d[937:1704] 

# Extract NPI area, 30-64N, 160-220E
x <- ncvar_get(nc, "lon", start=81, count=31)
y <- ncvar_get(nc, "lat", start=14, count=18)

SLP <- ncvar_get(nc, "prmsl", start=c(81,14,937), count=c(31,18,length(d)), verbose = F)

# manipulate as needed
SLP <- aperm(SLP, 3:1)  # First, reverse order of dimensions ("transpose" array)
SLP <- SLP[,18:1,]  # Reverse order of latitudes to be increasing for convenience (in later plotting)
y <- rev(y) 

SLP <- matrix(SLP, nrow=dim(SLP)[1], ncol=prod(dim(SLP)[2:3]))  # Change to matrix

# Keep track of corresponding latitudes and longitudes of each column:
lat <- rep(y, length(x))   # Vector of latitudes
lon <- rep(x, each = length(y))   # Vector of longitudes
dimnames(SLP) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

# check
 SLP.mean <- colMeans(SLP)
 z <- t(matrix(SLP.mean,length(y)))  
 image(x,y,z, col=tim.colors(64), xlim=c(130,250), ylim=c(20,66))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)
 
# now get monthly means weighted by area, using an arithmetic mean
weight <- sqrt(cos(lat*pi/180))

NPI.mu <- apply(SLP, 1, function(x) weighted.mean(x,weight, na.rm=T))

# aside - get 11-month rolling mean and save for later use

NPI.sm <- rollmean(NPI.mu, 11, fill=NA)

write.csv(NPI.sm, "NPI 11 mo rolling mean.csv")

# now limit to NDJ
m <- months(d)
NPI.mu <- NPI.mu[m %in% c("Nov", "Dec", "Jan")]
yr <- years(d)

# advance yr to match Jan
yr <- as.numeric(as.character(yr))
yr[m %in% c("Nov", "Dec")] <- 1 + yr[m %in% c("Nov", "Dec")]
yr <- yr[m %in% c("Nov", "Dec", "Jan")]

NPI.mu <- tapply(NPI.mu, yr, mean)

clim.vars$NDJ.NPI=NPI.mu[names(NPI.mu) %in% 1950:2012]
```

FMA PDO & NPGO.
```{r}
pdo <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/pdo-npgo/pdo.csv") 

pdo <- melt(pdo, id.vars = "YEAR")
pdo <- filter(pdo, variable %in% c("FEB", "MAR", "APR"))
pdo <- tapply(pdo$value, pdo$YEAR, mean)
clim.vars$FMA.PDO <- pdo[names(pdo) %in% 1950:2012]

npgo <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/pdo-npgo/npgo.csv") 
head(npgo)

npgo <- filter(npgo, MONTH %in% 2:4)
npgo <- tapply(npgo$NPGO, npgo$YEAR, mean)
clim.vars$FMA.NPGO <- npgo[names(npgo) %in% 1950:2012]
```

NDJ and SLP gradient.
```{r}
nc <- nc_open("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/slp.mon.mean.nc") # note that this is NCEP/NCAR!

# get date info - time is in hours since Jan. 1, 1800!
raw <- ncvar_get(nc, "time")
h <- raw/24
d <- dates(h, origin = c(1,1,1800))

# Pick start and end dates (Jan 1949-Dec 2014)
d <- d[13:804]

# Extract GOA SLP, 47.5-65 deg. N, 190-235 deg. E:
x <- ncvar_get(nc, "lon", start=77, count=19)
y <- ncvar_get(nc, "lat", start=11, count=8)

SLP <- ncvar_get(nc, "slp", start=c(77,11,13), count=c(19,8,length(d)), verbose = F)

SLP <- aperm(SLP, 3:1)  # reverse order of dimensions ("transpose" array)
SLP <- SLP[,8:1,]  # Reverse order of latitudes to be increasing for convenience (in later plotting)
y <- rev(y) 
SLP <- matrix(SLP, nrow=dim(SLP)[1], ncol=prod(dim(SLP)[2:3]))  # Change to matrix

# Keep track of corresponding latitudes and longitudes of each column:
lat <- rep(y, length(x))   # Vector of latitudes
lon <- rep(x, each = length(y))   # Vector of longitudes

# set names
dimnames(SLP) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

# now! let's figure a time series of annual K-S diffs !!!
ks.diff <- SLP[, "N55E230"] - SLP[, "N60E210"] # these coordinates are correct!

# now limit to NDJ
m <- months(d)
ks.diff <- ks.diff[m %in% c("Nov", "Dec", "Jan")]
yr <- years(d)

# advance yr to match Jan
yr <- as.numeric(as.character(yr))
yr[m %in% c("Nov", "Dec")] <- 1 + yr[m %in% c("Nov", "Dec")]
yr <- yr[m %in% c("Nov", "Dec", "Jan")]

ks.diff <- tapply(ks.diff, yr, mean)

clim.vars$NDJ.grad=ks.diff[names(ks.diff) %in% 1950:2012]
```

FMA & MJJ FW discharge.
```{r}
hill <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/hill.original.corrected.dates.csv") 

# compute Hill's anomalies
mu <- tapply(hill$input.km.3, hill$month, mean)
sd <- tapply(hill$input.km.3, hill$month, sd)

mu <- rep(mu, length.out=nrow(hill))
sd <- rep(sd, length.out=nrow(hill))

hill$total.anomaly <- (hill$input.km.3-mu)/sd

# limit to FMA and MJJ
fma.hill <- hill[hill$month %in% 2:4,]
fma.fw <- tapply(fma.hill$total.anomaly, fma.hill$year, mean)

mjj.hill <- hill[hill$month %in% 5:7,]
mjj.fw <- tapply(fma.hill$total.anomaly, fma.hill$year, mean)

clim.vars$FMA.FW[clim.vars$year %in% 1962:2009] <- fma.fw
clim.vars$MJJ.FW[clim.vars$year %in% 1962:2009] <- mjj.fw
```

FMA GAK1 salinity.
```{r}
# now GAK1 salinity....
data <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/gak1 2-17-17.csv")

data$year <- floor(data$dec.year)

require(lubridate)
data$day <- yday(date_decimal(data$dec.year)) # get Julian date

sal.set <- as.data.frame(tapply(data$sal, list(data$dec.year, data$depth), mean))
colnames(sal.set) <- c("d0", "d10", "d20", "d30", "d50", "d75", "d100", "d150", "d200", "d250")

sal.set$year <- floor(as.numeric(rownames(sal.set))) 
sal.set$day <- yday(date_decimal(as.numeric(rownames(sal.set))))

salFMA <- filter(sal.set, day>31 & day <=120 & year < 2013)

sal20mu <- tapply(salFMA$d20, salFMA$year, mean, na.rm=T)

clim.vars$FMA.sal[clim.vars$year %in% names(sal20mu)] <- sal20mu

```

FMA & MJJ SSH.
```{r}

unloadNamespace("lubridate")
# nc <- nc_open("/Users/MikeLitzow 1/Documents/R/NSF-GOA/non-analogue paper/hawaii_3e19_7ccd_16ff_3494_e686_2ec8.nc")

nc <- nc_open("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/hawaii_3e19_7ccd_16ff_e908_64db_63e9.nc")
# view dates (middle of month):
raw <- ncvar_get(nc, "time")
h <- raw/(24*60*60)
d <- dates(h, origin = c(1,1,1970))

ssh <- ncvar_get(nc, "ssh") # get all the data!
x <- ncvar_get(nc, "longitude")     # view longitudes (degrees East)
y <- ncvar_get(nc, "latitude")     # view latitudes
lat <- rep(y, length(x))   # Vector of latitudes
lon <- rep(x, each = length(y))   # Vector of longitudes

# process!
ssh <- aperm(ssh, 3:1)  # First, reverse order of dimensions ("transpose" array)

ssh <- matrix(ssh, nrow=dim(ssh)[1], ncol=prod(dim(ssh)[2:3]))  # Change to matrix

dimnames(ssh) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

# block out evertyhing but the area we want
ssh.mean <- colMeans(ssh)

drop <- ssh.mean < 0.07
ssh[,drop] <- NA

ssh[,lon < 198] <- NA
ssh[,lat < 55] <- NA

# check
 SSH.mean <- colMeans(ssh)
 z <- t(matrix(SSH.mean,length(y)))  
 image(x,y,z, col=tim.colors(64), xlim=c(180,250), ylim=c(50,64))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)
 
 # save x and y for study site plot
 x.ssh <- x
 y.ssh <- y

ssh.mean <- rowMeans(ssh, na.rm=T)

m <- months(d)
yr <- years(d)

ssh.fma <- ssh.mean[m %in% c("Feb", "Mar", "Apr")]
yr.fma <- yr[m %in% c("Feb", "Mar", "Apr")]
ssh.fma <- tapply(ssh.fma, yr.fma, mean)

ssh.mjj <- ssh.mean[m %in% c("May", "Jun", "Jul")]
yr.mjj <- yr[m %in% c("May", "Jun", "Jul")]
ssh.mjj <- tapply(ssh.mjj, yr.mjj, mean)

# drop 1949
ssh.fma <- ssh.fma[-1]
ssh.mjj <- ssh.mjj[-1]

clim.vars$FMA.SSH[clim.vars$year %in% names(ssh.fma)] <- ssh.fma
clim.vars$MJJ.SSH[clim.vars$year %in% names(ssh.mjj)] <- ssh.mjj
```

FMA and MJJ wind stress.
```{r}
# run the SSH code first!

taux <- ncvar_get(nc, "taux") # get all the data!

# process!
taux <- aperm(taux, 3:1)  # First, reverse order of dimensions ("transpose" array)

taux <- matrix(taux, nrow=dim(taux)[1], ncol=prod(dim(taux)[2:3]))  # Change to matrix

dimnames(taux) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

# block out evertyhing but the area we want
taux.mean <- colMeans(taux)
drop <- taux.mean > -0.02
taux[,drop] <- NA
taux[,lon<200] <- NA
taux.mean <- colMeans(taux)
# saving as a plot object, and also as a tauX.mean object that gets changed soon!
# (not great coding!)

land <- is.na(taux.mean)

# check
 taux.mean <- colMeans(taux)
 z <- t(matrix(taux.mean,length(y)))  
 image(x,y,z, col=tim.colors(64), xlim=c(180,250), ylim=c(50,64))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)

# y-stress
tauy <- ncvar_get(nc, "tauy") # get all the data!

# process!
tauy <- aperm(tauy, 3:1)  # First, reverse order of dimensions ("transpose" array)

tauy <- matrix(tauy, nrow=dim(tauy)[1], ncol=prod(dim(tauy)[2:3]))  # Change to matrix

dimnames(tauy) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

tauy[,lon < 218] <- NA
tauy[,lat < 54] <- NA

xx <- c(218,226)
yy <- c(58,52)

mod <- lm(yy ~ xx)
line.xx <- seq(xx[1], xx[2], by=0.1)
line.yy <- summary(mod)$coefficients[1,1] + summary(mod)$coefficients[2,1]*line.xx

for(i in 1:length(line.xx)){
  
  tauy[,(lon < line.xx[i] & lat < line.yy[i])] <- NA

}


# check
 tauy.mean <- colMeans(tauy)
 z <- t(matrix(tauy.mean,length(y)))  
 image.plot(x,y,z, col=tim.colors(64), xlim=c(180,250), ylim=c(50,64))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)

tauy <- rowMeans(tauy, na.rm=T)
taux <- rowMeans(taux, na.rm=T)

m <- months(d)
yr <- years(d)

taux.fma <- taux[m %in% c("Feb", "Mar", "Apr")]
yr.fma <- yr[m %in% c("Feb", "Mar", "Apr")]
taux.fma <- tapply(taux.fma, yr.fma, mean)

tauy.fma <- tauy[m %in% c("Feb", "Mar", "Apr")]
tauy.fma <- tapply(tauy.fma, yr.fma, mean)

taux.mjj <- taux[m %in% c("May", "Jun", "Jul")]
yr.mjj <- yr[m %in% c("May", "Jun", "Jul")]
taux.mjj <- tapply(taux.mjj, yr.mjj, mean)

tauy.mjj <- tauy[m %in% c("May", "Jun", "Jul")]
tauy.mjj <- tapply(tauy.mjj, yr.mjj, mean)

# drop 1949!
tauy.fma <- tauy.fma[-1]
tauy.mjj <- tauy.mjj[-1]

taux.fma <- taux.fma[-1]
taux.mjj <- taux.mjj[-1]

clim.vars$FMA.x.WS[clim.vars$year %in% names(taux.fma)] <- taux.fma
clim.vars$MJJ.x.WS[clim.vars$year %in% names(taux.mjj)] <- taux.mjj

clim.vars$FMA.y.WS[clim.vars$year %in% names(tauy.fma)] <- tauy.fma
clim.vars$MJJ.y.WS[clim.vars$year %in% names(tauy.mjj)] <- tauy.mjj
```
FMA total GOA wind stress.
```{r}
taux <- ncvar_get(nc, "taux") # get all the data!

# process!
taux <- aperm(taux, 3:1)  # First, reverse order of dimensions ("transpose" array)

taux <- matrix(taux, nrow=dim(taux)[1], ncol=prod(dim(taux)[2:3]))  # Change to matrix

dimnames(taux) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

tauy <- ncvar_get(nc, "tauy") # get all the data!

# process!
tauy <- aperm(tauy, 3:1)  # First, reverse order of dimensions ("transpose" array)

tauy <- matrix(tauy, nrow=dim(tauy)[1], ncol=prod(dim(tauy)[2:3]))  # Change to matrix

dimnames(tauy) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

stress <- sqrt(taux^2+tauy^2)

 # limit to GOA

 stress[,lat<55] <- NA

px <- c(197, 199, 200.5, 201.5, 203, 203.5, 204)
py <- c(55, 55.5, 56, 56.5, 57, 58, 59)

for(i in 1:length(px)){
  
  stress[,lat > py[i] & lon < px[i]] <- NA
}

# check
 stress.mean <- colMeans(stress)
 z <- t(matrix(stress.mean,length(y)))  
 image.plot(x,y,z, col=tim.colors(64), xlim=c(190,230), ylim=c(50,64))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)
lines(px, py, type="o", pch=19, col="red")

# save x and y for study site fig
x.stress <- x
y.stress <- y

mean.stress <- rowMeans(stress, na.rm = T)
m <- months(d)
yr <- years(d)

stress.fma <- mean.stress[m %in% c("Feb", "Mar", "Apr")]
yr.fma <- yr[m %in% c("Feb", "Mar", "Apr")]
stress.fma <- tapply(stress.fma, yr.fma, mean)

# drop 1949
stress.fma <- stress.fma[-1]
clim.vars$FMA.WS[clim.vars$year %in% names(stress.fma)] <- stress.fma
```



MJJ upwelling.
```{r}
ui <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/UI.data.may.2016.csv")

# change months to numbers for convenience
colnames(ui)[3:14] <- 1:12

# use the 3 northernmost positions
ui1 <- subset(ui, POSITION=="60N.149W")
ui2 <- subset(ui, POSITION=="60N.146W")
ui3 <- subset(ui, POSITION=="57N.137W")

# stack so that we can turn into a chronology
upwell <- stack(ui1, select=colnames(ui1)[3:14])
upwell$year <- rep(1946:2016, times=12)
colnames(upwell)[1:2] <- c("N60.W149", "month")

ui2 <- stack(ui2, select=colnames(ui2)[3:14])
ui3 <- stack(ui3, select=colnames(ui3)[3:14])

# add the other locations to "upwell"
upwell$N60.W146 <- ui2$values
upwell$N57.W137 <- ui3$values
# and order
upwell <- upwell[order(upwell$year),]

upwell$mean <- rowMeans(upwell[,c(1,4,5)])



mjj.up <- upwell[upwell$month %in% 5:7,]

mjj.uw <- tapply(mjj.up$mean, mjj.up$year, mean)

clim.vars$MJJ.UW <- mjj.uw[names(mjj.uw) %in% 1950:2012]
```

Papa index.
```{r}
papa <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/papa.csv")
clim.vars$Papa <- papa[papa$year %in% 1950:2012,2]
```

FMA and MJJ SST.
```{r}
nc <- nc_open("/Users/MikeLitzow 1/Documents/R/NSF-GOA/paper 1 final/submitted/sst.mnmean.v4.nc") 

d <- dates(ncvar_get(nc, "time"), origin=c(1,15,1800))

# Pick start and end dates (Jan 1949-Dec 2012):
d <- d[1141:1908]

# select the study area
# 54-62 deg. N, 200-226 deg. E
x <- ncvar_get(nc, "lon", start=101, count=14)
y <- ncvar_get(nc, "lat", start=14, count=5)

SST <- ncvar_get(nc, "sst", start=c(101,14,1141), count=c(14,5,length(d)))

# Change data from a 3-D array to a matrix of monthly data by grid point:
SST <- aperm(SST, 3:1)

SST <- SST[,5:1,]  # Reverse order of latitudes to be increasing for convenience (in later plotting)
y <- rev(y)  # Also reverse corresponding vector of lattidues
SST <- matrix(SST, nrow=dim(SST)[1], ncol=prod(dim(SST)[2:3]))  # Change to matrix

# Keep track of corresponding latitudes and longitudes of each column:
lat <- rep(y, length(x))   # Vector of latitudes
lon <- rep(x, each = length(y))   # Vector of longitudes
dimnames(SST) <- list(as.character(d), paste("N", lat, "E", lon, sep=""))

# need to drop Bristol Bay cells from study area!
BB <- c("N58E200", "N58E202", "N56E200")
SST[,BB] <- NA

# check
 sst.mean <- colMeans(SST)
 z <- t(matrix(sst.mean,length(y)))  
 image(x,y,z, col=tim.colors(64), xlim=c(180,250), ylim=c(50,64))
 contour(x, y, z, add=T)  
 map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=2)
 
 # save x and y for study site fig.
 x.sst <- x
 y.sst <- y
 
# get monthly values with weights adjusted by cell size
SST.mu <- apply(SST, 1, weighted.mean, w=sqrt(cos(lat*pi/180)), na.rm=T) 

m <- months(d)
yr <- years(d)

sst.fma <- SST.mu[m %in% c("Feb", "Mar", "Apr")]
yr.fma <- yr[m %in% c("Feb", "Mar", "Apr")]
sst.fma <- tapply(sst.fma, yr.fma, mean)

sst.mjj <- SST.mu[m %in% c("May", "Jun", "Jul")]
yr.mjj <- yr[m %in% c("May", "Jun", "Jul")]
sst.mjj <- tapply(sst.mjj, yr.mjj, mean)

clim.vars$FMA.SST <- sst.fma[names(sst.fma) %in% clim.vars$year]
clim.vars$MJJ.SST <- sst.mjj[names(sst.mjj) %in% clim.vars$year]
```

Save climate variables.
```{r}
write.csv(clim.vars, "clim vars for ordination.csv")
```

And make a study site figure.

```{r}
png("study site figure.png", 8,8, units="in", res=300)
par(mfrow=c(3,2), tcl=0.2, cex.lab=0.8, cex.axis=0.8, mar=c(2,2,2,0.5),mgp=c(1.5,0.3,0))
mt.cex <- 1.1
l.mar <- 3
l.cex <- 0.8
l.l <- 0.2
land.col <- "lightyellow3"
xlim <- c(190, 233)
ylim <- c(49,62)



z <- t(matrix(colMeans(stress),length(y.stress)))  # Re-shape to a matrix with latitudes in columns, longitudes in rows
zlim <- c(0, max(z, na.rm=T))
image.plot(x.stress,y.stress,z, col=tim.colors(64),  yaxt="n", xaxt="n", zlim=zlim, xlim=xlim, ylim=ylim, legend.cex=1.5, xlab="", ylab="")
map('world2Hires', 'Canada', fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires', 'usa',fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=1)
star.x <- c(210, 230)
star.y <- c(60,55)
points(star.x, star.y, pch=24,bg="#CC79A7", col="black", cex=2.7)
legend("bottomleft", legend= c("SLP stations"), pch=24, pt.bg="#CC79A7", col="black" , cex=1.7, ncol=1)
box()
mtext("a) Wind stress (Pa)", adj=0)


z <- t(matrix(colMeans(ssh),length(y.ssh)))  # Re-shape to a matrix with latitudes in columns, longitudes in rows
image.plot(x.ssh,y.ssh,z, col=tim.colors(64), zlim=c(-0.181, 0.181), yaxt="n", xaxt="n", xlim=xlim, ylim=ylim, xlab="", ylab="")
map('world2Hires', 'Canada', fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires', 'usa',fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=1)
box()
points(360-145,50, pch=21, bg="#56B4E9", col="black", cex=1.7)
text(360-145, 50, "Ocean Station Papa ", pos=2, cex=1.7)
mtext("b) Sea surface height (m)", adj=0)


z <- t(matrix(colMeans(SST), length(y.sst)))  # Re-shape to a matrix with latitudes in columns, longitudes in rows
image.plot(x.sst,y.sst,z, col=tim.colors(64), yaxt="n", xaxt="n", xlim=xlim, ylim=ylim, zlim=c(5,12), xlab="", ylab="")
box()
map('world2Hires', 'Canada', fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires', 'usa',fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=1)
mtext("c) Sea surface temperature (°C)", adj=0)


# load small-mesh locations
sm.dat <- read.csv("/Users/MikeLitzow 1/Documents/R/NSF-GOA/SHRIMP-stations.csv")


z <- t(matrix(colMeans(ssh),length(y.ssh)))  # Re-shape to a matrix with latitudes in columns, longitudes in rows
image(x.ssh,y.ssh,z, col=tim.colors(64), yaxt="n", xaxt="n", zlim=c(-9999,-999), xlim=xlim, ylim=ylim, ylab="", xlab="") # setting zlim so as to not plot!
box()
points(360+sm.dat$lon_centro, sm.dat$lat_centro, cex=1.2, pch=19, col=alpha("#D55E00", alpha=0.05))
map('world2Hires', 'Canada', fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires', 'usa',fill=T,xlim=c(130,250), ylim=c(20,70),add=T, lwd=0.5, col=land.col)
map('world2Hires',fill=F,xlim=c(130,250), ylim=c(20,66),add=T, lwd=1)
mtext("d) ", adj=0)
uw.x <- c(360-149, 360-146, 360-137)
uw.y <- c(60,60,57)
gak.y <- 59 + (50.7/60)
gak.x <- 360-149 + (28/60)
sitk.x <- 360-135.33
sitk.y <- 57.05
points(uw.x, uw.y, pch=21, bg="#009E73", col="black", cex=1.7)
points(gak.x, gak.y, pch=21, bg="#CC79A7", col="black", cex=1.7)
points(sitk.x, sitk.y, pch=23, bg="#F0E442", cex=1.7)
legend("bottomleft", legend= c("Downwelling", "Salinity", "Herring", "Trawl survey"), pch=c(21,21,23,22), pt.bg=c("#009E73", "#CC79A7", "#F0E442", alpha("#D55E00", alpha=0.8)), col=c("black", "black", "black", "white") , bty="o", cex=1.7, ncol=2)

# location...
# study site box
x1 <- c(190,190,233,233,190)
y1 <- c(49,62,62,49,49)

par(mar=c(2,2,2,4))
plot(10,10, type="n", xlim=c(130,250), ylim=c(20,66), xlab="", ylab="", xaxt="n", yaxt="n")
map('world2Hires', 'Canada', fill=T, add=T, lwd=0.5, col=land.col)
map('world2Hires', 'usa',fill=T, add=T, lwd=0.5, col=land.col)
map('world2Hires', 'Mexico',fill=T, add=T, lwd=0.5, col=land.col)
map('world2Hires', 'hawaii',fill=T,add=T, lwd=0.5, col=land.col)
map('world2Hires', 'ussr',fill=T,add=T, lwd=0.5, col=land.col)
map('world2Hires', 'China',fill=T,add=T, lwd=0.5, col=land.col)
map('world2Hires', 'Japan',fill=T,add=T, lwd=0.5, col=land.col)
map('world2Hires', 'South Korea',fill=T,add=T, lwd=0.5, col=land.col)
map('world2Hires', 'North Korea',fill=T,add=T, lwd=0.5, col=land.col)
map('world2Hires',fill=F,add=T, lwd=1)
lines(x1,y1, lwd=2, col="#D55E00")
mtext("e) ", adj=0)
dev.off()
```

